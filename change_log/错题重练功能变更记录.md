# 错题重练功能变更记录

## 功能概述

本次更新实现了错题本页面的错题重练功能，用户可以在错题本页面一键开始重练所有错题，并直接跳转到刷题页面。

---

## 需求回顾

用户需求：
1. 在错题本页面中增加错题重练入口
2. 要求能刷错题本列表中的全部错题
3. 从错题本页面直接跳转到刷题页面
4. 在后端开放新的接口来完成这套逻辑，不要污染已有功能
5. 在新的git分支完成此次工作（从ai_exams分支创建）
6. 关键业务逻辑代码必须有中文注释

---

## 变更内容

### 后端变更

#### 1. 新增API端点：`POST /api/mistakes/retry-all`

**文件**：`src/backend/app/api/mistakes.py`

**变更详情**：
- 新增 `RetryAllRequest` 请求模型
- 新增 `/retry-all` API端点
- 支持获取错题本中的所有错题（不限制数量）
- 创建包含所有错题的刷题批次
- 使用 `mode="mistakes_retry"` 标识错题重练批次

**关键业务逻辑**：
- 使用 `ReviewService.get_wrong_questions(db, user_id, course_id, limit=10000)` 获取所有错题
- 批次大小 = 错题总数
- 为每道错题创建答题记录

**API响应示例**：
```json
{
  "batch_id": "uuid-string",
  "questions": [...],
  "total_count": 15
}
```

---

### 前端变更

#### 1. API Client 新增方法

**文件**：`src/frontend/lib/api.ts`

**变更详情**：
- 新增 `retryAllMistakes()` 方法
- 调用 `/api/mistakes/retry-all` 端点
- 支持按课程筛选错题

#### 2. 错题本页面添加重练入口

**文件**：`src/frontend/app/mistakes/page.tsx`

**变更详情**：
- 新增 `handleRetryAll()` 处理函数
  - 调用 `retryAllMistakes()` API
  - 获取 batch_id 后跳转到刷题页面

- 新增"错题重练"按钮（位于Stats Card下方）
  - 显示错题总数
  - 只在有错题时显示
  - 使用醒目的红色样式

**UI效果**：
- 按钮文案："开始错题重练 ({total_wrong} 题)"
- 提示文案："系统会自动创建包含所有错题的刷题批次"

#### 3. 刷题页面支持加载现有批次

**文件**：`src/frontend/app/quiz/page.tsx`

**变更详情**：
- 新增 `batch_id` URL参数解析
- 新增 `loadBatchDirect()` 函数，用于加载已存在的批次
- 修改自动开始逻辑，优先处理 `batch_id` 参数

**关键业务逻辑**：
- 优先级：`batch_id` > `course_id`
  - 如果提供 `batch_id`，直接加载该批次（错题重练）
  - 如果只提供 `course_id`，创建新批次（普通刷题）

---

## 用户体验流程

### 错题重练流程

1. 用户访问错题本页面
2. 查看错题列表和统计信息
3. 点击"开始错题重练 (X 题)"按钮
4. 系统创建包含所有错题的批次
5. 自动跳转到刷题页面
6. 逐题作答
7. 完成批次后查看成绩和解析

---

## 技术设计要点

### 1. 功能隔离

**后端**：
- 新增独立的 `/retry-all` 端点
- 不修改现有的 `/retry` 接口
- 避免污染已有功能

**前端**：
- 新增独立的 `retryAllMistakes()` 方法
- 复用现有的刷题页面逻辑
- 通过 `batch_id` 参数区分批次来源

### 2. 数据流

```
错题本页面
  ↓ 点击按钮
POST /api/mistakes/retry-all
  ↓ 返回 batch_id
跳转到 /quiz?batch_id={id}
  ↓
GET /api/quiz/{id}/questions
  ↓
加载所有错题开始答题
  ↓
POST /api/quiz/{id}/answer (提交答案）
  ↓
POST /api/quiz/{id}/finish (完成批次）
```

### 3. 模式标识

**批次模式区分**：
- `mode="practice"` - 普通刷题模式
- `mode="mistakes_retry"` - 错题重练模式

**目的**：
- 方便后续统计分析
- 区分不同来源的批次
- 不影响现有批次逻辑

---

## 测试说明

### 手动测试步骤

1. **准备测试数据**：
   - 确保有用户数据
   - 确保有错题记录

2. **后端API测试**：
   ```bash
   # 测试获取所有错题并创建批次
   curl -X POST http://localhost:8000/api/mistakes/retry-all \
     -H "Content-Type: application/json" \
     -d '{"user_id": "test_user_id"}'
   ```

3. **前端功能测试**：
   - 访问错题本页面
   - 验证"开始错题重练"按钮显示
   - 点击按钮，验证跳转到刷题页面
   - 验证批次包含所有错题
   - 逐题作答，验证答案提交
   - 完成批次，验证成绩和解析显示

### 浏览器测试

- Chrome、Firefox、Safari、Edge 等主流浏览器
- 检查按钮样式和响应式布局

---

## 变更文件列表

### 后端
- `src/backend/app/api/mistakes.py`
  - 新增 `RetryAllRequest` 模型
  - 新增 `/retry-all` API端点

### 前端
- `src/frontend/lib/api.ts`
  - 新增 `retryAllMistakes()` 方法

- `src/frontend/app/mistakes/page.tsx`
  - 新增 `handleRetryAll()` 函数
  - 新增"错题重练"按钮UI

- `src/frontend/app/quiz/page.tsx`
  - 新增 `batch_id` 参数支持
  - 新增 `loadBatchDirect()` 函数
  - 修改自动开始逻辑

### 文档
- `change_intent/错题重练功能实现.md` - 实现方案
- `change_log/错题重练功能变更记录.md` - 本文件

---

## 风险与注意事项

### 1. 性能风险

**场景**：错题数量过多（如 > 500 题）

**缓解措施**：
- 前端显示加载提示
- 批次创建时使用大limit值（10000）

### 2. 数据一致性

**场景**：错题重练过程中，错题本变化

**说明**：
- 批次创建时快照错题列表
- 批次完成后，错题本根据新结果更新
- 这是预期行为

### 3. 兼容性

**QuizBatch 模型**：
- 确认模型支持 `mode` 字段
- 确认模型不依赖 `course_id`

---

## 后续优化方向

1. **分批重练**：支持将大量错题分成多个批次
2. **进度追踪**：记录错题重练的历史和统计
3. **个性化推荐**：基于错题类型和难度推荐重练顺序
4. **复习提醒**：错题重练完成后，根据艾宾浩斯曲线提醒再次复习

---

## 代码审查要点

### 后端
- API端点逻辑是否正确
- 批次创建流程是否完整
- 中文注释是否清晰

### 前端
- 错误处理是否完善
- 导航逻辑是否正确
- UI样式是否友好

### 功能
- 是否能刷完所有错题
- 导航是否流畅
- 答案提交是否正确

---

## Git提交信息

```
feat: 添加错题重练功能

- 新增 POST /api/mistakes/retry-all 端点，支持全部错题重练
- 前端错题本页面添加错题重练入口按钮
- 支持从错题本直接跳转到刷题页面
- 刷题页面支持通过 batch_id 加载现有批次
- 关键业务逻辑添加中文注释
```

---

## 总结

本次更新实现了完整的错题重练功能，满足用户需求：
- ✅ 在错题本页面增加错题重练入口
- ✅ 支持刷错题本列表中的全部错题
- ✅ 从错题本页面直接跳转到刷题页面
- ✅ 后端开放新的独立接口，不污染已有功能
- ✅ 在新分支 `feature/wrong-answer-retry` 完成
- ✅ 关键业务逻辑代码有中文注释
