# 章节详情页增强功能实现记录

## 实现日期
2026-02-20

## 分支信息
- **分支名**: `feature/chapter-detail-enhancement`
- **基于**: `origin/develop`
- **Worktree 路径**: `/Users/crazzie/Codes/aie55_llm5_learnhub_chapter_detail`

## 实现内容

### 1. 字数统计和预计用时展示

**新增文件**: `src/frontend/components/ContentStats.tsx`

**功能**:
- 统计 Markdown 内容的字数（中文字符 + 英文单词）
- 计算预计阅读时间（按 300 字/分钟）
- 显示在章节标题下方

**实现要点**:
- 使用正则表达式移除代码块、公式、Markdown 标记等
- 支持中文和英文字数统计
- 大数字自动格式化（如 1.2k, 1.5万）

### 2. 左侧大纲导航栏

**新增文件**: `src/frontend/components/OutlineNav.tsx`

**功能**:
- 自动提取 Markdown 的 h1/h2/h3 标题
- 点击标题可滚动到对应位置
- 滚动时高亮当前标题

**实现要点**:
- 使用正则表达式提取标题
- 监听滚动事件更新激活标题
- 支持标题层级缩进显示

### 3. 上一章/下一章导航

**修改文件**: `src/frontend/app/learning/page.tsx`

**功能**:
- 底部显示上一章/下一章按钮
- 无上/下一章时按钮禁用
- 显示当前章节位置（如 3/10）

**实现要点**:
- 使用 `useMemo` 计算相邻章节
- 章节切换通过 URL 参数实现
- 响应式设计，小屏幕简化显示

### 4. MarkdownReader 组件增强

**修改文件**: `src/frontend/components/MarkdownReader.tsx`

**改动**:
- 使用 `forwardRef` 暴露滚动容器
- 为标题元素添加唯一 ID
- 导出 `MarkdownReaderRef` 接口

## 文件变更清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `src/frontend/components/ContentStats.tsx` | 新增 | 字数统计组件 |
| `src/frontend/components/OutlineNav.tsx` | 新增 | 大纲导航组件 |
| `src/frontend/app/learning/page.tsx` | 修改 | 集成新功能，调整布局 |
| `src/frontend/components/MarkdownReader.tsx` | 修改 | 添加 ref 支持，标题 ID |

## 布局调整

```
┌─────────────────────────────────────────────────────────────┐
│ 顶部导航栏                                                   │
├──────┬──────────────────────────────────┬──────────────────┤
│      │ 章节标题 | 字数: 1,234 | 约 4 分钟  │                  │
│ 大纲 │──────────────────────────────────│                  │
│ 导航 │                                  │   AI Assistant   │
│(xl+) │     Markdown 内容               │                  │
│      │                                  │                  │
│      │──────────────────────────────────│                  │
│      │  ← 上一章        3/10    下一章 → │                  │
├──────┴──────────────────────────────────┴──────────────────┤
```

## 响应式设计

- **xl 屏幕**: 显示左侧大纲导航
- **lg 及以下**: 隐藏大纲导航，保留字数统计和章节导航

## 技术细节

### 字数统计算法
1. 移除代码块（``` 包裹的内容）
2. 移除行内代码（` 包裹的内容）
3. 移除 LaTeX 公式（$ 和 $$ 包裹的内容）
4. 移除 Markdown 标记（#、*、- 等）
5. 统计中文字符数（Unicode 范围 \u4e00-\u9fa5）
6. 统计英文单词数（连续字母序列）

### 大纲导航滚动同步
- 使用 `useCallback` 优化滚动处理函数
- 缓存标题元素位置避免重复计算
- 监听滚动事件更新当前激活标题

### 组件间通信
- MarkdownReader 通过 `forwardRef` 暴露滚动容器
- 父组件通过 state 存储 scrollContainer 并传递给 OutlineNav
- 使用 setTimeout 确保 ref 在渲染后可用

## 注意事项

1. **中文注释要求**: 所有核心业务逻辑包含中文注释
2. **原注释保留**: 未删除任何原有注释
3. **主题适配**: 新组件使用 CSS 变量，支持深色/浅色主题

## 后续优化建议

1. 大纲导航可考虑添加展开/折叠功能
2. 章节导航可添加键盘快捷键支持
3. 字数统计可考虑添加阅读进度指示
