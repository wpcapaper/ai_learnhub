# 错题重练功能实现方案

## 需求概述

在错题本页面中增加错题重练入口，要求：
1. 能刷错题本列表中的全部错题
2. 从错题本页面直接跳转到刷题页面
3. 在后端开放新的接口来完成这套逻辑，不要污染已有功能
4. 在新的git分支完成此次工作（从ai_exams分支创建）
5. 关键业务逻辑代码必须有中文注释

---

## 现状分析

### 已有功能

#### 后端 (mistakes.py)
- `/api/mistakes/` - 获取错题列表
- `/api/mistakes/stats` - 获取错题统计
- `/api/mistakes/retry` - 重试错题（批次模式）

**现有 retry 接口的问题：**
```python
@router.post("/retry", response_model=dict)
def retry_wrong_questions(request: RetryRequest, db: Session = Depends(get_db)):
    # 问题：默认 batch_size=10，只返回前10道错题
    # 问题：如果错题数超过10，用户无法一次刷完所有错题
    questions_to_retry = wrong_questions[:request.batch_size]
```

#### 前端 (mistakes/page.tsx)
- 显示错题列表和统计
- **缺少：**错题重练入口按钮

#### 前端 API Client (lib/api.ts)
```typescript
// 已有方法，但前端未使用
async retryMistakes(userId: string, courseId?: string, batchSize = 10): Promise<{ batch_id: string; questions: Question[] }>
```

#### 刷题页面 (quiz/page.tsx)
- 支持 course_id 参数自动开始批次
- 已有完整的答题流程

---

## 实现方案

### 核心设计原则

1. **不污染已有功能**：新增独立的API端点和服务方法
2. **完整刷题体验**：支持刷完错题本中的全部错题
3. **复用现有流程**：使用现有的刷题页面和批次逻辑
4. **清晰的用户路径**：错题本 → 点击"错题重练" → 跳转刷题页面

---

## 详细设计

### 1. 后端实现

#### 1.1 新增API端点：`POST /api/mistakes/retry-all`

**目的**：创建包含错题本中所有错题的刷题批次

**文件修改**：`src/backend/app/api/mistakes.py`

```python
# 新增 Request 模型
class RetryAllRequest(BaseModel):
    """全部错题重练请求"""
    user_id: str
    course_id: Optional[str] = None  # 可选，用于筛选特定课程的错题


# 新增API端点
@router.post("/retry-all", response_model=dict)
def retry_all_wrong_questions(
    request: RetryAllRequest,
    db: Session = Depends(get_db)
):
    """
    重练错题本中的全部错题

    业务逻辑说明：
    - 获取错题本中的所有错题（无数量限制）
    - 创建刷题批次，批次大小 = 错题总数
    - 支持按课程筛选（course_id参数）
    - 复用现有的QuizService.start_batch()和ReviewService.get_wrong_questions()
    - 与现有错题重练接口/mistakes/retry完全解耦，不污染已有功能

    Args:
        request: 包含user_id和可选的course_id

    Returns:
        dict: 包含batch_id和题目列表
            {
                "batch_id": "批次ID",
                "questions": [...],  # 所有错题
                "total_count": 错题总数
            }
    """
    from app.services.review_service import ReviewService

    # 获取错题本中的所有错题（不限制数量）
    wrong_data = ReviewService.get_wrong_questions(
        db, request.user_id, request.course_id, limit=10000
    )
    wrong_questions = wrong_data["questions"]

    # 如果没有错题，返回提示
    if not wrong_questions:
        raise HTTPException(status_code=404, detail="没有错题可重练")

    # 创建批次，批次大小 = 错题总数
    # 关键业务逻辑：使用ReviewService.get_wrong_questions()获取的题目创建批次
    # 避免与现有的QuizService.start_batch()耦合，防止逻辑冲突
    import uuid
    from datetime import datetime
    from app.models import QuizBatch, BatchAnswer

    # 确定course_id（用于批次关联）
    # 如果请求中有course_id，使用它；否则使用第一道错题的course_id
    batch_course_id = request.course_id
    if not batch_course_id and wrong_questions:
        batch_course_id = wrong_questions[0].course_id

    # 创建批次
    batch = QuizBatch(
        id=str(uuid.uuid4()),
        user_id=request.user_id,
        batch_size=len(wrong_questions),
        mode="mistakes_retry",  # 新增模式：错题重练
        started_at=datetime.utcnow(),
        status="in_progress"
    )

    # 如果有course_id，添加到批次（可选，用于统计）
    if batch_course_id:
        # 注意：QuizBatch模型可能没有course_id字段，需要根据实际情况调整
        # 如果模型中有，取消下面的注释
        # batch.course_id = batch_course_id
        pass

    db.add(batch)
    db.flush()

    # 为每道错题创建答题记录
    for question in wrong_questions:
        answer = BatchAnswer(
            id=str(uuid.uuid4()),
            batch_id=batch.id,
            question_id=question.id,
            user_answer=None,
            is_correct=None,
            answered_at=None
        )
        db.add(answer)

    db.commit()
    db.refresh(batch)

    # 返回批次信息
    return {
        "batch_id": batch.id,
        "questions": [
            {
                "id": q.id,
                "content": q.content,
                "question_type": q.question_type,
                "options": q.options
            }
            for q in wrong_questions
        ],
        "total_count": len(wrong_questions)
    }
```

**设计说明：**
- **不污染现有接口**：新增独立的 `/retry-all` 端点
- **支持全部错题**：使用 `limit=10000` 确保获取所有错题
- **清晰的模式标识**：`mode="mistakes_retry"` 区分普通刷题
- **灵活的课程筛选**：支持按课程筛选错题

#### 1.2 修改批次完成逻辑（可选）

**问题**：错题重练的批次完成后，需要更新错题的复习状态

**考虑**：现有的 `QuizService.finish_batch()` 已经会调用 `ReviewService.submit_answer()` 更新学习记录，所以不需要额外修改。

**验证**：确认错题重练的答案会被正确记录到学习记录中。

---

### 2. 前端实现

#### 2.1 修改 API Client

**文件修改**：`src/frontend/lib/api.ts`

```typescript
// 在 Mistakes APIs 区域新增方法
async retryAllMistakes(userId: string, courseId?: string): Promise<{ batch_id: string; questions: Question[]; total_count: number }> {
  const body: any = { user_id: userId };
  if (courseId) body.course_id = courseId;
  return this.fetchJson<{ batch_id: string; questions: Question[]; total_count: number }>('/api/mistakes/retry-all', {
    method: 'POST',
    body: JSON.stringify(body),
  });
}
```

#### 2.2 修改错题本页面，添加重练入口

**文件修改**：`src/frontend/app/mistakes/page.tsx`

在错题列表的顶部（Stats Card 之后，Mistakes List 之前）添加"错题重练"按钮：

```typescript
// 在组件中添加处理函数
const handleRetryAll = async () => {
  if (!user) return;

  try {
    // 调用新的全部错题重练API
    const result = await apiClient.retryAllMistakes(user.id, courseId || undefined);

    // 跳转到刷题页面，传递batch_id
    const url = `/quiz?batch_id=${result.batch_id}`;
    window.location.href = url;
  } catch (error) {
    console.error('Failed to start wrong answer practice:', error);
    alert('开始错题重练失败: ' + (error as Error).message);
  }
};
```

在JSX中添加按钮（Stats Card 之后）：

```typescript
{/* 错题重练按钮 */}
{stats && stats.total_wrong > 0 && (
  <div className="mb-6">
    <button
      onClick={handleRetryAll}
      className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-all hover:shadow-lg"
    >
      开始错题重练 ({stats.total_wrong} 题)
    </button>
    <p className="text-sm text-gray-600 mt-2 text-center">
      系统会自动创建包含所有错题的刷题批次
    </p>
  </div>
)}
```

**设计说明：**
- **显眼的入口**：使用红色醒目按钮，位于Stats Card下方
- **清晰的数量提示**：按钮上显示错题总数
- **友好的提示**：按钮下方说明系统行为
- **条件显示**：只有当有错题时才显示按钮

---

## 实现步骤

### 步骤1：创建新分支

```bash
git checkout ai_exams
git pull origin ai_exams
git checkout -b feature/wrong-answer-retry
```

### 步骤2：实现后端API

1. 修改 `src/backend/app/api/mistakes.py`
   - 添加 `RetryAllRequest` 模型
   - 添加 `/retry-all` 端点
   - 添加中文注释

### 步骤3：实现前端功能

1. 修改 `src/frontend/lib/api.ts`
   - 添加 `retryAllMistakes()` 方法

2. 修改 `src/frontend/app/mistakes/page.tsx`
   - 添加 `handleRetryAll` 函数
   - 添加错题重练按钮

### 步骤4：测试验证

1. **API测试**：
   ```bash
   # 测试 /api/mistakes/retry-all
   curl -X POST http://localhost:8000/api/mistakes/retry-all \
     -H "Content-Type: application/json" \
     -d '{"user_id": "test_user_id"}'
   ```

2. **前端测试**：
   - 访问错题本页面
   - 点击"错题重练"按钮
   - 验证跳转到刷题页面
   - 验证批次包含所有错题
   - 完成答题，验证答案记录正确

### 步骤5：编写变更文档

1. 创建 `change_log/错题重练功能实现.md`
   - 功能说明
   - 技术方案
   - 变更文件列表
   - 测试说明

### 步骤6：代码审查

1. 运行后端测试（如有）
2. 运行前端构建：`npm run build`
3. 运行 LSP 诊断

### 步骤7：提交代码

```bash
git add .
git commit -m "feat: 添加错题重练功能"
  - 新增 /api/mistakes/retry-all 端点，支持全部错题重练
  - 前端错题本页面添加错题重练入口按钮
  - 支持从错题本直接跳转到刷题页面
  - 关键业务逻辑添加中文注释
git push origin feature/wrong-answer-retry
```

---

## 技术要点

### 1. 为什么不修改现有的 `/retry` 接口？

**原因**：
- 现有接口已有固定用途（批量重试，默认10题）
- 修改现有接口可能影响已有功能
- 新增独立接口更清晰，易于维护

### 2. 如何确保批次包含所有错题？

**方法**：
- 使用 `ReviewService.get_wrong_questions(limit=10000)` 获取所有错题
- 批次大小 = 错题总数
- 避免使用 `request.batch_size` 参数

### 3. 错题重练模式的标识

**使用 `mode="mistakes_retry"`**：
- 区分普通刷题（`mode="practice"`）
- 方便后续统计分析
- 不影响现有批次逻辑

### 4. 导航流程

**错题本 → 刷题页面**：
```
用户点击"错题重练"
  ↓
调用 /api/mistakes/retry-all
  ↓
获得 batch_id
  ↓
跳转到 /quiz?batch_id=<batch_id>
  ↓
刷题页面识别batch_id，加载批次题目
```

---

## 风险评估

### 1. 性能风险

**场景**：错题数量过多（如 > 500 题）

**影响**：
- 批次创建可能较慢
- 刷题页面加载可能较慢
- 数据库事务可能较大

**缓解措施**：
- 设置合理的 `limit` 值（如 10000）
- 前端显示加载提示
- 考虑分批重练（未来优化）

### 2. 数据一致性

**场景**：错题重练过程中，错题本中的错题发生变化

**影响**：
- 批次题目与当前错题本不一致

**说明**：
- 批次创建时快照错题列表
- 批次完成后，错题本会根据新的答题结果更新
- 这是预期行为，无需特殊处理

### 3. 兼容性

**场景**：QuizBatch 模型没有 course_id 字段

**处理**：
- 批次可以不关联课程（不使用 course_id）
- 批次只用于错题重练，不影响课程进度统计

---

## 后续优化方向

1. **分批重练**：支持将大量错题分成多个批次
2. **进度追踪**：记录错题重练的历史和统计
3. **个性化推荐**：基于错题类型和难度推荐重练顺序
4. **复习提醒**：错题重练完成后，根据艾宾浩斯曲线提醒再次复习

---

## 总结

本方案通过新增独立的API端点和前端入口，实现了错题本页面的错题重练功能：
- ✅ 支持刷错题本中的全部错题
- ✅ 从错题本直接跳转到刷题页面
- ✅ 不污染已有功能
- ✅ 关键业务逻辑有中文注释
- ✅ 在新分支完成，代码可追溯
